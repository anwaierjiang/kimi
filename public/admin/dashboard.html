<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <title>ç®¡ç†åå° - å®‰ç»´ç§‘æŠ€</title>
  <link rel="stylesheet" href="admin.css">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- å¯¼èˆªæ  -->
  <nav class="admin-nav">
    <div class="nav-container">
      <a href="/" class="logo">å®‰ç»´ç§‘æŠ€ - ç®¡ç†åå°</a>
      <ul class="nav-tabs">
        <li><a href="#dashboard" class="nav-tab active" onclick="showSection('dashboard')">ä»ªè¡¨ç›˜</a></li>
        <li><a href="#messages" class="nav-tab" onclick="showSection('messages')">ç•™è¨€ç®¡ç†</a></li>
        <li><a href="#products" class="nav-tab" onclick="showSection('products')">å•†å“ç®¡ç†</a></li>
        <li><a href="#orders" class="nav-tab" onclick="showSection('orders')">è®¢å•ç®¡ç†</a></li>
      </ul>
    </div>
  </nav>

  <!-- ä¸»è¦å†…å®¹ -->
  <div class="admin-content">
    <div class="container">
      <!-- ä»ªè¡¨ç›˜ -->
      <section id="dashboard" class="section active">
        <div class="page-header">
          <h1 class="page-title">ğŸ“Š ä»ªè¡¨ç›˜</h1>
          <p class="page-subtitle">å®æ—¶ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œä¸šåŠ¡æ•°æ®</p>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid">
          <div class="stats-card">
            <div class="stats-number" id="totalMessages">0</div>
            <div class="stats-label">æ€»ç•™è¨€æ•°</div>
          </div>
          <div class="stats-card">
            <div class="stats-number" id="totalProducts">0</div>
            <div class="stats-label">å•†å“æ€»æ•°</div>
          </div>
          <div class="stats-card">
            <div class="stats-number" id="totalOrders">0</div>
            <div class="stats-label">è®¢å•æ€»æ•°</div>
          </div>
          <div class="stats-card">
            <div class="stats-number" id="pendingOrders">0</div>
            <div class="stats-label">å¾…å¤„ç†è®¢å•</div>
          </div>
        </div>

        <!-- æœ€è¿‘æ´»åŠ¨ -->
        <div class="admin-card">
          <div class="card-header">
            <h2 class="card-title">ğŸ•’ æœ€è¿‘æ´»åŠ¨</h2>
          </div>
          <div id="recentActivity">
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ç•™è¨€ç®¡ç† -->
      <section id="messages" class="section">
        <div class="page-header">
          <h1 class="page-title">ğŸ’¬ ç•™è¨€ç®¡ç†</h1>
          <p class="page-subtitle">æŸ¥çœ‹å’Œç®¡ç†ç”¨æˆ·ç•™è¨€ä¿¡æ¯</p>
        </div>

        <div class="admin-card">
          <div class="card-header">
            <h2 class="card-title">ç•™è¨€åˆ—è¡¨</h2>
            <button class="btn btn-primary" onclick="refreshMessages()">åˆ·æ–°</button>
          </div>
          <div id="messagesList">
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- å•†å“ç®¡ç† -->
      <section id="products" class="section">
        <div class="page-header">
          <h1 class="page-title">ğŸ›ï¸ å•†å“ç®¡ç†</h1>
          <p class="page-subtitle">ç®¡ç†å•†å“ä¿¡æ¯ï¼Œæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤å•†å“</p>
        </div>

        <div class="admin-card">
          <div class="card-header">
            <h2 class="card-title">å•†å“åˆ—è¡¨</h2>
            <button class="btn btn-primary" onclick="showAddProductModal()">æ·»åŠ å•†å“</button>
          </div>
          <div id="productsList">
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- è®¢å•ç®¡ç† -->
      <section id="orders" class="section">
        <div class="page-header">
          <h1 class="page-title">ğŸ“¦ è®¢å•ç®¡ç†</h1>
          <p class="page-subtitle">æŸ¥çœ‹å’Œå¤„ç†ç”¨æˆ·è®¢å•</p>
        </div>

        <div class="admin-card">
          <div class="card-header">
            <h2 class="card-title">è®¢å•åˆ—è¡¨</h2>
            <button class="btn btn-primary" onclick="refreshOrders()">åˆ·æ–°</button>
          </div>
          <div id="ordersList">
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>åŠ è½½ä¸­...</p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- æ·»åŠ å•†å“æ¨¡æ€æ¡† -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">æ·»åŠ å•†å“</h3>
        <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
      </div>
      <form id="addProductForm">
        <div class="form-group">
          <label for="productTitle">å•†å“æ ‡é¢˜</label>
          <input type="text" id="productTitle" name="title" required>
        </div>
        <div class="form-group">
          <label for="productPrice">ä»·æ ¼</label>
          <input type="number" id="productPrice" name="price" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="productDesc">æè¿°</label>
          <textarea id="productDesc" name="desc" required></textarea>
        </div>
        <div class="form-group">
          <label for="productCover">å°é¢å›¾ç‰‡</label>
          <input type="text" id="productCover" name="cover" placeholder="å›¾ç‰‡æ–‡ä»¶å">
        </div>
        <div class="form-group">
          <label for="productTaobaoUrl">æ·˜å®é“¾æ¥</label>
          <input type="url" id="productTaobaoUrl" name="taobaoUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label for="productStatus">çŠ¶æ€</label>
          <select id="productStatus" name="status">
            <option value="on">ä¸Šæ¶</option>
            <option value="off">ä¸‹æ¶</option>
          </select>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary">æ·»åŠ å•†å“</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ç¼–è¾‘å•†å“æ¨¡æ€æ¡† -->
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ç¼–è¾‘å•†å“</h3>
        <button class="modal-close" onclick="closeModal('editProductModal')">&times;</button>
      </div>
      <form id="editProductForm">
        <input type="hidden" id="editProductId" name="id">
        <div class="form-group">
          <label for="editProductTitle">å•†å“æ ‡é¢˜</label>
          <input type="text" id="editProductTitle" name="title" required>
        </div>
        <div class="form-group">
          <label for="editProductPrice">ä»·æ ¼</label>
          <input type="number" id="editProductPrice" name="price" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="editProductDesc">æè¿°</label>
          <textarea id="editProductDesc" name="desc" required></textarea>
        </div>
        <div class="form-group">
          <label for="editProductCover">å°é¢å›¾ç‰‡</label>
          <input type="text" id="editProductCover" name="cover" placeholder="å›¾ç‰‡æ–‡ä»¶å">
        </div>
        <div class="form-group">
          <label for="editProductTaobaoUrl">æ·˜å®é“¾æ¥</label>
          <input type="url" id="editProductTaobaoUrl" name="taobaoUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label for="editProductStatus">çŠ¶æ€</label>
          <select id="editProductStatus" name="status">
            <option value="on">ä¸Šæ¶</option>
            <option value="off">ä¸‹æ¶</option>
          </select>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
          <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('editProductModal')">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentSection = 'dashboard';

    // æ˜¾ç¤º/éšè—é¡µé¢éƒ¨åˆ†
    function showSection(sectionId) {
      // éšè—æ‰€æœ‰éƒ¨åˆ†
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      // ç§»é™¤æ‰€æœ‰å¯¼èˆªæ ‡ç­¾çš„activeç±»
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
      document.getElementById(sectionId).classList.add('active');
      event.target.classList.add('active');
      
      currentSection = sectionId;
      
      // æ ¹æ®éƒ¨åˆ†åŠ è½½ç›¸åº”æ•°æ®
      switch(sectionId) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'messages':
          loadMessages();
          break;
        case 'products':
          loadProducts();
          break;
        case 'orders':
          loadOrders();
          break;
      }
    }

    // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
    async function loadDashboardData() {
      try {
        const [messages, products, orders] = await Promise.all([
          fetch('/admin/messages').then(r => r.json()),
          fetch('/admin/products').then(r => r.json()),
          fetch('/admin/orders').then(r => r.json())
        ]);

        document.getElementById('totalMessages').textContent = messages.length;
        document.getElementById('totalProducts').textContent = products.length;
        document.getElementById('totalOrders').textContent = orders.length;
        document.getElementById('pendingOrders').textContent = orders.filter(o => o.status === 'pending').length;

        // æ˜¾ç¤ºæœ€è¿‘æ´»åŠ¨
        const recentActivity = document.getElementById('recentActivity');
        const activities = [];
        
        // æ·»åŠ æœ€è¿‘çš„ç•™è¨€
        messages.slice(-3).forEach(msg => {
          activities.push({
            type: 'message',
            content: `æ–°ç•™è¨€: ${msg.name} - ${msg.message.substring(0, 50)}...`,
            time: new Date(msg.createdAt || Date.now()).toLocaleString()
          });
        });

        // æ·»åŠ æœ€è¿‘çš„è®¢å•
        orders.slice(-3).forEach(order => {
          activities.push({
            type: 'order',
            content: `æ–°è®¢å•: ${order.product} - ${order.email}`,
            time: new Date(order.createdAt).toLocaleString()
          });
        });

        // æŒ‰æ—¶é—´æ’åº
        activities.sort((a, b) => new Date(b.time) - new Date(a.time));

        recentActivity.innerHTML = activities.slice(0, 5).map(activity => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
            <div>
              <div style="font-weight: 600; color: var(--fg-primary);">${activity.content}</div>
              <div style="font-size: 0.9rem; color: var(--fg-secondary);">${activity.time}</div>
            </div>
            <div style="font-size: 1.5rem;">
              ${activity.type === 'message' ? 'ğŸ’¬' : 'ğŸ“¦'}
            </div>
          </div>
        `).join('') || '<p style="text-align: center; color: var(--fg-secondary);">æš‚æ— æ´»åŠ¨</p>';

      } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showNotification('åŠ è½½æ•°æ®å¤±è´¥', 'error');
      }
    }

    // åŠ è½½ç•™è¨€
    async function loadMessages() {
      try {
        const response = await fetch('/admin/messages');
        const messages = await response.json();
        
        const messagesList = document.getElementById('messagesList');
        if (messages.length === 0) {
          messagesList.innerHTML = '<p style="text-align: center; color: var(--fg-secondary);">æš‚æ— ç•™è¨€</p>';
          return;
        }

        messagesList.innerHTML = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>å§“å</th>
                <th>é‚®ç®±</th>
                <th>ä¸»é¢˜</th>
                <th>ç•™è¨€å†…å®¹</th>
                <th>æ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${messages.map(msg => `
                <tr>
                  <td>${msg.name || 'åŒ¿å'}</td>
                  <td>${msg.email || 'æ— '}</td>
                  <td>${msg.subject || 'æ— ä¸»é¢˜'}</td>
                  <td>${(msg.message || msg.content || '').substring(0, 50)}...</td>
                  <td>${new Date(msg.createdAt || Date.now()).toLocaleString()}</td>
                  <td>
                    <button class="btn btn-danger" onclick="deleteMessage('${msg._id}')">åˆ é™¤</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load messages:', error);
        showNotification('åŠ è½½ç•™è¨€å¤±è´¥', 'error');
      }
    }

    // åŠ è½½å•†å“
    async function loadProducts() {
      try {
        const response = await fetch('/admin/products');
        const products = await response.json();
        
        const productsList = document.getElementById('productsList');
        if (products.length === 0) {
          productsList.innerHTML = '<p style="text-align: center; color: var(--fg-secondary);">æš‚æ— å•†å“</p>';
          return;
        }

        productsList.innerHTML = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>æ ‡é¢˜</th>
                <th>ä»·æ ¼</th>
                <th>çŠ¶æ€</th>
                <th>æè¿°</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${products.map(product => `
                <tr>
                  <td>${product.title}</td>
                  <td>Â¥${product.price}</td>
                  <td><span class="status-badge ${product.status === 'on' ? 'status-on' : 'status-off'}">${product.status === 'on' ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}</span></td>
                  <td>${(product.desc || '').substring(0, 50)}...</td>
                  <td>
                    <button class="btn btn-secondary" onclick="editProduct('${product._id}')" style="margin-right: 0.5rem;">ç¼–è¾‘</button>
                    <button class="btn btn-danger" onclick="deleteProduct('${product._id}')">åˆ é™¤</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load products:', error);
        showNotification('åŠ è½½å•†å“å¤±è´¥', 'error');
      }
    }

    // åŠ è½½è®¢å•
    async function loadOrders() {
      try {
        const response = await fetch('/admin/orders');
        const orders = await response.json();
        
        const ordersList = document.getElementById('ordersList');
        if (orders.length === 0) {
          ordersList.innerHTML = '<p style="text-align: center; color: var(--fg-secondary);">æš‚æ— è®¢å•</p>';
          return;
        }

        ordersList.innerHTML = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>å•†å“</th>
                <th>é‚®ç®±</th>
                <th>çŠ¶æ€</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(order => `
                <tr>
                  <td>${order.product}</td>
                  <td>${order.email}</td>
                  <td><span class="status-badge ${order.status === 'pending' ? 'status-pending' : 'status-done'}">${order.status === 'pending' ? 'å¾…å¤„ç†' : 'å·²å®Œæˆ'}</span></td>
                  <td>${new Date(order.createdAt).toLocaleString()}</td>
                  <td>
                    ${order.status === 'pending' ? 
                      `<button class="btn btn-success" onclick="markOrderDone('${order._id}')">æ ‡è®°å®Œæˆ</button>` :
                      '<span style="color: var(--fg-secondary);">å·²å®Œæˆ</span>'
                    }
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        console.error('Failed to load orders:', error);
        showNotification('åŠ è½½è®¢å•å¤±è´¥', 'error');
      }
    }

    // åˆ é™¤ç•™è¨€
    async function deleteMessage(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) return;
      
      try {
        const response = await fetch(`/admin/messages/${id}`, { method: 'DELETE' });
        if (response.ok) {
          showNotification('ç•™è¨€åˆ é™¤æˆåŠŸ', 'success');
          loadMessages();
        } else {
          showNotification('åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('Failed to delete message:', error);
        showNotification('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // åˆ é™¤å•†å“
    async function deleteProduct(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
      
      try {
        const response = await fetch(`/admin/products/${id}`, { method: 'DELETE' });
        if (response.ok) {
          showNotification('å•†å“åˆ é™¤æˆåŠŸ', 'success');
          loadProducts();
        } else {
          showNotification('åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('Failed to delete product:', error);
        showNotification('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    // æ ‡è®°è®¢å•å®Œæˆ
    async function markOrderDone(id) {
      try {
        const response = await fetch(`/admin/orders/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'done' })
        });
        if (response.ok) {
          showNotification('è®¢å•å·²æ ‡è®°ä¸ºå®Œæˆ', 'success');
          loadOrders();
        } else {
          showNotification('æ“ä½œå¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('Failed to mark order done:', error);
        showNotification('æ“ä½œå¤±è´¥', 'error');
      }
    }

    // æ˜¾ç¤ºæ·»åŠ å•†å“æ¨¡æ€æ¡†
    function showAddProductModal() {
      document.getElementById('addProductModal').classList.add('show');
    }

    // ç¼–è¾‘å•†å“
    async function editProduct(id) {
      try {
        const response = await fetch(`/admin/products/${id}`);
        const product = await response.json();
        
        document.getElementById('editProductId').value = product._id;
        document.getElementById('editProductTitle').value = product.title;
        document.getElementById('editProductPrice').value = product.price;
        document.getElementById('editProductDesc').value = product.desc;
        document.getElementById('editProductCover').value = product.cover;
        document.getElementById('editProductTaobaoUrl').value = product.taobaoUrl;
        document.getElementById('editProductStatus').value = product.status;
        
        document.getElementById('editProductModal').classList.add('show');
      } catch (error) {
        console.error('Failed to load product:', error);
        showNotification('åŠ è½½å•†å“ä¿¡æ¯å¤±è´¥', 'error');
      }
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // åˆ·æ–°æ•°æ®
    function refreshMessages() {
      loadMessages();
    }

    function refreshOrders() {
      loadOrders();
    }

    // è¡¨å•æäº¤å¤„ç†
    document.getElementById('addProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      
      try {
        const response = await fetch('/admin/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('å•†å“æ·»åŠ æˆåŠŸ', 'success');
          closeModal('addProductModal');
          this.reset();
          loadProducts();
        } else {
          showNotification('æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('Failed to add product:', error);
        showNotification('æ·»åŠ å¤±è´¥', 'error');
      }
    });

    document.getElementById('editProductForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());
      const id = data.id;
      delete data.id;
      
      try {
        const response = await fetch(`/admin/products/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          showNotification('å•†å“æ›´æ–°æˆåŠŸ', 'success');
          closeModal('editProductModal');
          loadProducts();
        } else {
          showNotification('æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('Failed to update product:', error);
        showNotification('æ›´æ–°å¤±è´¥', 'error');
      }
    });

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboardData();
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });
  </script>

  <style>
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
  </style>
</body>
</html>